<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Alpha Husky Dashboard</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="preload" as="image" href="background_poster.jpg">
  <link rel="preload" as="video" href="background3.webm" type="video/webm">
  <link rel="preload" as="video" href="background3.mp4" type="video/mp4">
  <style>
  /* Telegram theme + bezpieczne fallbacki */
  :root { color-scheme: var(--tg-color-scheme, dark); }
  :root { --glass: rgba(0,0,0,.45); --stroke: rgba(255,255,255,.18); --txt: var(--tg-theme-text-color, #fff); --ring: rgba(255,255,255,.12); }
  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; background: var(--tg-theme-bg-color, #000); color: var(--tg-theme-text-color, #fff); overscroll-behavior:none; }
  a { color: var(--tg-theme-link-color, #aef); }
  /* twarde nadpisanie ‚Äûblack‚Äù */
  .text-black, .text-[#000], .text-[black] { color: var(--tg-theme-text-color, #ffffff) !important; }
  .bg-black, .bg-[#000], .bg-[black] { background: var(--tg-theme-secondary-bg-color, #12171d) !important; }
  .app { position: fixed; inset: 0; overflow: hidden; height: calc(var(--vh, 1vh) * 100); }
  .bg { position: absolute; inset: 0; z-index: 0; }
  .bg video, .bg .poster { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
  .bg video { filter: contrast(1.08) brightness(.9); }
  .bg .poster { display:none; background-position:center; background-size:cover; }
  .ui { position: absolute; inset: 0; z-index: 2; }
  .grid { position:absolute; inset:0; display:grid; place-items:end center; padding: 24px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
  /* === HUD: boczne kolumny + centralny skin === */
  .hud-layout{
    width:100%;
    max-width:520px;
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
  }
  .hud-col{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .hud-col .btn{
    min-width:0;
    padding:8px 10px;
    font-size:13px;
  }
  .hero-center{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-end;
    gap:6px;
  }
  .hero-frame{
    width:min(46vw, 210px);
    aspect-ratio:3/4;
    border-radius:24px;
    background:
      radial-gradient(circle at top left, rgba(0,229,255,.2), transparent 60%),
      radial-gradient(circle at bottom right, rgba(255,176,0,.2), transparent 60%),
      rgba(0,0,0,.7);
    border:1px solid rgba(255,255,255,.22);
    box-shadow:0 18px 40px rgba(0,0,0,.6);
    overflow:hidden;
  }
  .hero-frame img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .hero-caption{
    font-size:13px;
    display:flex;
    gap:6px;
    align-items:center;
    justify-content:center;
    padding:4px 8px;
    border-radius:999px;
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.16);
    backdrop-filter:blur(8px);
  }
  @media (max-width:380px){
    .hud-layout{ gap:8px; }
    .hud-col .btn{
      font-size:12px;
      padding:6px 8px;
    }
    .hero-frame{ width:56vw; }
  }
  .btn {
    appearance:none; border:none; padding:12px 16px; border-radius:16px; color:var(--txt);
    background:var(--glass); border:1px solid var(--stroke);
    font:600 16px system-ui, sans-serif; cursor:pointer; transition: transform .08s ease;
    display: flex; /* Umo≈ºliwia column layout w .btn.map */
    align-items: center;
    justify-content: center;
  }
  .btn:active { transform: translateY(1px); }
  .btn.linklike { text-decoration:none; }
  /* Og√≥lny styl dla ikon w buttonach */
  .btn-icon {
    width: 28px;
    height: 28px;
    margin-bottom: 4px;
    display: block;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    transition: filter 0.2s ease;
  }
  /* Specyficznie dla Map ‚Äì mroczny vibe, mniejszy rozmiar */
  .btn.map {
    flex-direction: column;
    align-items: center;
    padding: 8px 12px;
    background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(20,20,40,0.9));
    border: 1px solid rgba(139, 69, 19, 0.6);
    min-width: 70px;
    height: auto;
    font-size: 14px;
  }
  .btn.map:hover .btn-icon {
    filter: drop-shadow(0 2px 8px rgba(255, 0, 0, 0.4)) brightness(1.1);
  }
  .btn.map:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
  }
  .btn.primary {
    background: var(--tg-theme-button-color, rgba(16,185,129,.18));
    color: var(--tg-theme-button-text-color, #fff);
    border: 1px solid rgba(255,255,255,.18);
  }
  .topbar {
    position:absolute; top:12px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center;
    padding: calc(8px + env(safe-area-inset-top)) 12px 8px; border-radius:14px;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.25)); border:1px solid var(--stroke);
    color:#cfe7ff; font:500 14px system-ui, sans-serif;
  }
  .badge { padding:4px 8px; border-radius:999px; border:1px solid var(--stroke); background:rgba(0,0,0,.35); color:#aef; font-weight:700; }
  .spacer { height: max(12px, env(safe-area-inset-bottom)); }
  @media (prefers-reduced-motion: reduce) { .bg video { display:none; } .bg .poster { display:block; } }
  .fallback {
    position: absolute; inset: 0; display:none; z-index: 3;
    background: rgba(0,0,0,.8); color:#fff; font: 500 16px system-ui, sans-serif;
    align-items:center; justify-content:center; text-align:center; padding:24px;
  }
  .fallback a { color:#aef; text-decoration:underline; }
  .map-back { position:fixed; inset:0; z-index: 4; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.75); }
  .map-wrap { width:min(96vw,1200px); padding:12px; }
  .map-card { background:rgba(12,14,18,.82); border:1px solid var(--ring); border-radius:16px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.5); }
  .map-head { display:flex; justify-content:space-between; align-items:center; gap:10px; padding:6px 4px 10px; }
  .map-head h2 { margin:0; font:600 16px system-ui, sans-serif; color:#fff; letter-spacing:.2px; }
  .close-x { cursor:pointer; padding:6px 10px; border-radius:10px; border:1px solid var(--ring); background:#111; color:#fff; }
  .map{ position:relative; width:100%; aspect-ratio:16/9;
    background: url("images/map/base/wasteland.jpg") center/cover no-repeat;
    border-radius:16px; overflow:hidden; box-shadow:0 0 0 1px var(--ring) inset; }
  .map::after{ content:""; position:absolute; inset:0; z-index:2;
    background: url("images/map/overlays/fog.png") center/cover no-repeat,
                linear-gradient(0deg, rgba(0,0,0,.55), transparent);
    pointer-events:none; }
  .paths-layer{ position:absolute; inset:0; z-index:0; pointer-events:none; }
  .paths-layer svg{ width:100%; height:100%; }
  .pins{ position:absolute; inset:0; z-index:3; }
  .hotspot{ position:absolute; transform:translate(-50%,-50%); text-align:center;
    padding:0; background:none; border:none; cursor:pointer;
    z-index:3; transition: transform .12s ease, filter .12s ease; }
  .hotspot:hover{ transform:translate(-50%,-50%) scale(1.05); z-index:3; }
  .hotspot::before{ content:""; position:absolute; left:50%; top:50%;
    width: clamp(48px, 7vw, 120px); height: clamp(22px, 3.4vw, 60px);
    transform: translate(-50%, calc(-50% + 20px));
    background: url("images/map/decals/decal_soft.png") center/contain no-repeat;
    opacity:.9; filter: blur(.2px); pointer-events:none; }
  .hotspot img{ width: clamp(40px, 3.6vw, 72px);
    filter: drop-shadow(0 10px 16px rgba(0,0,0,.55)); pointer-events:none; }
  .hotspot.unlocked img{
    filter: drop-shadow(0 10px 16px rgba(0,0,0,.55))
            drop-shadow(-2px 0 6px rgba(0,229,255,.22))
            drop-shadow( 2px 0 6px rgba(155,77,255,.22));
  }
  .hotspot.locked img{ filter: grayscale(1) opacity(.7) drop-shadow(0 8px 14px rgba(0,0,0,.55)); }
  .ping{ position:absolute; left:50%; top:50%; width: clamp(40px, 3.8vw, 76px); height: clamp(40px, 3.8vw, 76px);
    transform: translate(-50%,-50%); border-radius:50%; animation:ping 1.4s infinite; pointer-events:none; }
  .hotspot.unlocked .ping{ background:rgba(0,229,255,.14); }
  .hotspot.locked .ping{ background:rgba(148,163,184,.10); }
  @keyframes ping{ 0%{ transform:translate(-50%,-50%) scale(.9); opacity:.9 } 100%{ transform:translate(-50%,-50%) scale(1.6); opacity:0 } }
  .chip{ position:absolute; left:50%; transform:translateX(-50%); margin-top:6px;
    font-size:12px; line-height:1; padding:6px 10px; border-radius:999px;
    background:rgba(10,12,16,.8); border:1px solid rgba(255,255,255,.07); color:#fff; white-space:nowrap;
    backdrop-filter: blur(3px); }
  .chip::before{ content:""; position:absolute; top:-6px; left:50%; width:10px; height:10px;
    transform: translateX(-50%) rotate(45deg); background:inherit; border-left:inherit; border-top:inherit; }
  .lock-badge{ position:absolute; right:-6px; top:-6px; width:22px; height:22px; border-radius:50%;
    background:rgba(18,20,26,.96); border:1px solid rgba(255,255,255,.08);
    display:flex; align-items:center; justify-content:center; font-size:12px; color:#cbd5e1;
    box-shadow: 0 2px 6px rgba(0,0,0,.5); }
  .lock-badge img{ width:14px; height:14px; opacity:.9 }
  .path{ fill:none; stroke:rgba(255,255,255,.25); stroke-width:2.2; stroke-linecap:round; stroke-linejoin:round; filter:drop-shadow(0 0 2px rgba(0,0,0,.6)); }
  .path.locked{ stroke:rgba(255,255,255,.16); }
  .path.glow{ stroke-width:4; stroke:rgba(255,0,0,.08); }
  .locked-back, .sheet-back { position:fixed; inset:0; z-index:5; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.7); }
  .locked-card, .sheet-card{ width:min(92vw,480px); background:rgba(0,0,0,.85); border:1px solid var(--ring); border-radius:16px; padding:18px; color: var(--tg-theme-text-color, #fff); }
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0; }
  .tab.active{ outline:2px solid rgba(255,255,255,.18); }
  /* progress + region sheet width */
  .progress-pill{display:flex;gap:8px;align-items:center;border:1px solid var(--ring);
    background:rgba(0,0,0,.45);border-radius:999px;padding:6px 10px;color:#cfe7ff;
    font:600 12px system-ui}
  .progress-bar{width:140px;max-width:28vw;height:8px;border-radius:999px;
    background:rgba(255,255,255,.1);overflow:hidden}
  .progress-bar>i{display:block;height:100%;width:0%;
    background:linear-gradient(90deg,rgba(0,229,255,.6),rgba(155,77,255,.6))}
  .region-sheet .sheet-card{width:min(92vw,520px)}
  .muted { color: var(--tg-theme-hint-color, #9aa4ad); }
  /* DEBUG banner (pojedynczy) */
  #dbg{position:fixed; right:8px; top:8px; z-index:9; font:600 11px system-ui;
    background:rgba(0,0,0,.6); color:#fff; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.12); display:none}
  /* Avatar/Skins modal */
  .avatar-sheet .sheet-card {
    width: min(92vw, 520px);
    max-height: 80vh;
    overflow: auto;
  }
  .avatar-sheet canvas {
    max-width: 100%;
    height: auto;
  }
  .skin-btn.active { background: var(--tg-theme-button-color, rgba(16,185,129,.18)); color: var(--tg-theme-button-text-color, #fff); }
  .skins-grid{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:10px 0; }
  </style>
  <!-- ‚¨á‚¨á‚¨á Mission Board (inline CSS) + NOWY CSS DLA DESC -->
  <style id="quests-css">
    .q-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9999}
    .q-modal-body{background:#0b0f14;border:1px solid #243244;border-radius:14px;width:min(720px,92vw);max-height:86vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:16px}
    .q-modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .q-title{margin:0;font-size:18px}
    .q-head-actions{display:flex;gap:6px}
    .q-btn{border:1px solid #2a3b4d;background:#14202c;color:#d9e3ec;border-radius:10px;padding:6px 10px;cursor:pointer}
    .q-btn:hover{filter:brightness(1.1)}
    .q-btn-ghost{background:transparent;border-color:#2a3b4d}
    .q-btn-acc{background:#1e2937;border-color:#3a516a}
    .q-status{font-size:12px;opacity:.9;margin:0 2px 10px 2px}
    .q-loader,.q-empty{padding:16px;opacity:.85}
    .q-filters{display:flex;gap:6px;margin:6px 2px 10px 2px;flex-wrap:wrap}
    .q-tab{border:1px solid #243244;background:#0f1620;color:#d7e0ea;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    .q-tab--on{background:#172433}
    .quest-board{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:720px){.quest-board{grid-template-columns:1fr 1fr}}
    .quest{border:1px solid #243244;border-radius:12px;padding:10px;background:#0e141b}
    .q-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .q-name{font-weight:600}
    .q-type{opacity:.7;font-size:12px;margin-left:6px}
    .q-head-right{display:flex;gap:8px;align-items:center}
    .q-step{font-size:12px;opacity:.8}
    .q-done{font-size:12px;background:#1b3a28;color:#b1f2c0;border:1px solid #2c5e43;padding:2px 6px;border-radius:999px}
    .q-reqs{display:flex;flex-direction:column;gap:8px}
    .q-row-top{display:flex;align-items:center;justify-content:space-between;font-size:12px;margin-bottom:4px}
    .q-req-name{opacity:.9}
    .q-req-val{opacity:.7}
    .q-bar{height:6px;border-radius:999px;background:#16202a;overflow:hidden}
    .q-bar-fill{height:100%;background:#2b8bd9}
    .q-rew{margin-top:8px}
    .q-badge{display:inline-block;border:1px solid #2a3b4d;border-radius:999px;padding:2px 8px;margin:2px;font-size:11px;opacity:.95}
    .q-actions{margin-top:10px;display:flex;gap:8px}
    #quests-launcher.q-launcher{position:fixed;right:16px;bottom:16px;width:44px;height:44px;border-radius:999px;border:1px solid #2a3b4d;background:#0f1620;color:#e5eef7;font-size:20px;cursor:pointer;z-index:9999;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    #quests-launcher.q-launcher:hover{filter:brightness(1.08)}

    /* ‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê */
    /* NOWY CSS DLA OPIS√ìW (desc) ‚Äì dzia≈Ça idealnie */
    .q-name-wrapper { 
      flex: 1; 
    }
    .q-desc {
      font-size: 13px;
      color: #a0d8ff;
      margin-top: 5px;
      line-height: 1.35;
      opacity: 0.92;
    }
    .q-hint {
      font-style: italic;
      color: #88c0ff;
      font-size: 12.5px;
      margin-top: 4px;
    }
    /* ‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê */
  </style>
  <!-- FAQ styles (inline, je≈õli brak osobnego CSS) -->
  <style id="faq-styles">
  /* Floating FAQ button */
  .fab-faq{
    position: fixed;
    left: max(14px, env(safe-area-inset-left));
    bottom: max(18px, calc(env(safe-area-inset-bottom) + 18px));
    z-index: 1200;
    display: inline-flex; align-items: center; gap: .45rem;
    padding: .55rem .8rem; border-radius: 999px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.45); backdrop-filter: blur(6px);
    color: #eaeaea; cursor: pointer; user-select: none;
    box-shadow: 0 6px 24px rgba(0,0,0,.35);
  }
  .fab-faq:hover{ border-color: rgba(255,255,255,.28); }
  .fab-faq:active{ transform: translateY(1px); }
  .fab-faq svg{ opacity:.9 }
  @media (max-width: 420px){
    .fab-faq span{ display:none; }
    .fab-faq{ padding:.6rem; border-radius:16px; }
  }
  /* FAQ modal */
  .faq-modal[hidden]{ display:none; }
  .faq-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); }
  .faq-sheet{ position:fixed; inset:6% 4% auto 4%; max-height:88vh; background:rgba(10,10,14,.92);
    border:1px solid rgba(255,255,255,.1); border-radius:16px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.6); color:#eaeaea; }
  @media (min-width:800px){ .faq-sheet{ inset:8% 12% auto 12%; } }
  .faq-header{ display:flex; align-items:center; justify-content:space-between; padding:.9rem 1rem; border-bottom:1px solid rgba(255,255,255,.08); }
  .faq-header h2{ margin:0; font-size:1.05rem; letter-spacing:.2px; }
  .faq-close{ border:0; background:transparent; color:#aaa; font-size:1.1rem; cursor:pointer; }
  .faq-close:hover{ color:#fff; }
  .faq-toolbar{ display:flex; gap:.6rem; padding:.7rem 1rem; border-bottom:1px solid rgba(255,255,255,.06); flex-wrap:wrap; }
  #faqSearch{ flex:1 1 220px; padding:.55rem .7rem; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.35); color:#eaeaea; }
  #faqSearch::placeholder{ color:#9aa; }
  .faq-tabs{ display:flex; gap:.4rem; overflow:auto; scrollbar-width:none; }
  .faq-tabs::-webkit-scrollbar{ display:none; }
  .faq-tab{ padding:.45rem .65rem; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); border-radius:999px; font-size:.85rem; cursor:pointer; white-space:nowrap; }
  .faq-tab[aria-selected="true"]{ border-color:#00E5FF; box-shadow:0 0 0 1px rgba(0,229,255,.25) inset; }
  .faq-list{ padding:.4rem 1rem 1rem; max-height:58vh; overflow:auto; }
  .faq-item{ border:1px solid rgba(255,255,255,.08); border-radius:12px; background:rgba(0,0,0,.25); margin:.5rem 0; overflow:hidden; }
  .faq-q{ width:100%; text-align:left; padding:.7rem .9rem; background:transparent; color:#eaeaea; border:0; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
  .faq-q span{ font-weight:600; font-size:.95rem; }
  .faq-q svg{ opacity:.7; transition: transform .18s ease; }
  .faq-item[open] .faq-q svg{ transform:rotate(180deg); }
  .faq-a{ padding:.5rem .9rem 1rem; color:#cfd5db; line-height:1.45; border-top:1px solid rgba(255,255,255,.06); }
  .faq-a p{ margin:.45rem 0; }
  .faq-a code, .faq-a kbd{ background:rgba(255,255,255,.06); padding:.08rem .35rem; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; }
  .faq-footer{ display:flex; justify-content:space-between; align-items:center; padding:.6rem 1rem; border-top:1px solid rgba(255,255,255,.08); }
  .faq-copylink{ border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.25); color:#eaeaea; padding:.4rem .6rem; border-radius:10px; cursor:pointer; }
  .faq-hint{ color:#9aa; font-size:.85rem; }
  </style>
</head>
<body>
  <div id="dbg">init‚Ä¶</div>
  <div class="app">
    <div class="bg">
      <video autoplay muted loop playsinline poster="background_poster.jpg" preload="metadata">
        <source src="background3.webm" type="video/webm" />
        <source src="background3.mp4" type="video/mp4" />
      </video>
      <div class="poster" style="background-image:url('background_poster.jpg');"></div>
    </div>
    <div id="app" class="ui">
      <div class="topbar">
        <div id="player">Alpha Husky</div>
        <div class="badge" id="faction">PACK</div>
      </div>
      <div class="grid">
        <div class="hud-layout">
          <!-- LEWA KOLUMNA (utility / progres) -->
          <div class="hud-col hud-left">
            <button class="btn map" aria-label="Open Alpha Map" type="button">
              <img src="images/ui/map-icon.png" alt="Alpha Map" class="btn-icon">
              <span>Alpha Map</span>
            </button>
            <button class="btn mission" aria-label="Open Missions" type="button">Mission</button>
            <button class="btn inventory" aria-label="Open Inventory" type="button">Inventory</button>
            <button class="btn shop" aria-label="Open Shop" type="button">Shop</button>
            <button class="btn howlboard" aria-label="Open Howlboard" type="button">Howlboard</button>
            <button class="btn profile" aria-label="Open Profile" type="button">Profile</button>
          </div>
          <!-- ≈öRODEK ‚Äì SKIN / HERO -->
          <div class="hero-center">
            <div class="hero-frame" id="heroFrame">
              <img
                id="player-skin"
                src="/assets/skins/lunarhowl_skin.webp"
                alt="Alpha Husky skin">
            </div>
            <div class="hero-caption">
              <span id="heroName">Alpha Husky</span>
              <span>¬∑</span>
              <span id="heroLevel">Lv.1</span>
            </div>
          </div>
          <!-- PRAWA KOLUMNA (to≈ºsamo≈õƒá / companions) -->
          <div class="hud-col hud-right">
            <button class="btn avatar" aria-label="Open Avatar" type="button">Avatar</button>
            <button class="btn skins" aria-label="Open Skins" type="button">Skins</button>
            <button class="btn char" aria-label="Open Character" type="button">Character</button>
            <button class="btn pets" aria-label="Open Pets" type="button">Pets</button>
            <button class="btn equipped" aria-label="Open Equipped" type="button">Equipped</button>
            <button class="btn feed" aria-label="Open Feed" type="button">Feed</button>
            <button class="btn mypets" aria-label="Open MyPets" type="button">MyPets</button>
          </div>
        </div>
        <div class="spacer"></div>
      </div>

    <!-- MAP MODAL -->
    <div class="map-back" id="mapBack">
      <div class="map-wrap">
        <div class="map-card">
          <div class="map-head">
            <h2>Regions Map</h2>
            <div id="unlockProgress" class="progress-pill" style="display:none">
              <span id="unlockLabel">Moon Lab</span>
              <span class="progress-bar"><i id="unlockFill"></i></span>
              <span id="unlockCount">0/5</span>
            </div>
            <button class="close-x" id="closeMap" type="button">√ó</button>
          </div>
          <div id="map" class="map" data-map-root>
            <div class="paths-layer"><svg id="pathsSVG" viewBox="0 0 1000 562" preserveAspectRatio="xMidYMid meet"></svg></div>
            <div class="pins" id="pins"></div>
            <canvas id="particlesCanvas" class="particles-layer" width="1000" height="562" style="position:absolute; inset:0; pointer-events:none; display:none;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Locked info -->
    <div class="locked-back" id="lockedBack">
      <div class="locked-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-weight:600;" id="lockedTitle">Locked</div>
          <button class="btn" id="closeLocked" type="button">√ó</button>
        </div>
        <p id="lockedDesc" style="opacity:.85;font-size:14px;line-height:1.4;margin:8px 0 14px;"></p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn linklike" id="lockedShop" type="button">Open Shop</button>
          <button class="btn linklike" id="lockedForge" type="button">Open Forge</button>
          <button class="btn primary" id="lockedAsk" type="button">Ask the Bot</button>
        </div>
      </div>
    </div>

    <!-- Howlboard modal -->
    <div class="sheet-back" id="boardBack">
      <div class="sheet-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:700;">Howlboard</div>
          <button class="btn" id="closeBoard" type="button">√ó</button>
        </div>
        <div class="tabs" style="margin-top:10px;">
          <button class="tab" data-sort="bones" type="button">Bones</button>
          <button class="tab" data-sort="level" type="button">Level</button>
          <button class="tab" data-sort="howls" type="button">Howls</button>
        </div>
        <p style="opacity:.8;margin-top:10px;">Choose a tab to open the board in the bot.</p>
      </div>
    </div>

   <!-- Region Sheet modal -->
<div class="sheet-back region-sheet" id="regionBack">
  <div class="sheet-card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div id="regionTitle" style="font-weight:700;"></div>
      <button class="btn" id="closeRegion" type="button">√ó</button>
    </div>
    <p id="regionDesc" style="opacity:.85;margin-top:8px;"></p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
      <button class="btn primary" id="regionGo" type="button">Travel</button>
      <button class="btn linklike" id="regionLore" type="button">Lore</button>
    </div>
  </div>
</div>

<!-- SKINS MODAL -->
<div class="sheet-back avatar-sheet" id="avatarBack">
  <div class="sheet-card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700;">Skin Gallery</div>
      <button class="btn" id="closeAvatar" type="button">√ó</button>
    </div>
    <canvas id="skinCanvas" width="400" height="600" style="display:block; margin:20px auto; border:1px solid var(--ring); border-radius:8px; background:rgba(0,0,0,.5);"></canvas>
    <div style="text-align:center; opacity:.8; font-size:12px;" id="skinDesc">‚Äî</div>
    <div style="display:flex; gap:8px; justify-content:center; margin:10px 0;">
      <button class="btn primary" id="equipSkin" type="button">Equip Skin</button>
      <button class="btn" id="shareSkin" type="button">Share Flex</button>
    </div>
    <!-- Galeria skin√≥w renderowana dynamicznie -->
    <div id="skinButtons" class="skins-grid"></div>
  </div>
</div>

<!-- Building modal (HTTP) -->
<div class="sheet-back" id="buildingBack">
  <div class="sheet-card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div id="buildingTitle" style="font-weight:700;">Building</div>
      <button class="btn" id="closeBuilding" type="button">√ó</button>
    </div>
    <p id="buildingDesc" class="muted" style="margin-top:8px;"></p>
    <div id="buildingState" style="display:grid;gap:8px;margin-top:6px;">
      <div><b>Status:</b> <span id="buildingStatus">‚Äî</span></div>
      <div id="buildingTimerWrap" style="display:none;"><b>Time Left:</b> <span id="buildingTimer">0s</span></div>
      <div id="buildingRoutesWrap" style="display:none;">
        <label for="buildingRoute" class="muted" style="font-size:12px;">Route</label>
        <select id="buildingRoute" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:rgba(255,255,255,.05);color:#fff"></select>
      </div>
    </div>
    <div class="btn-row" style="margin-top:12px;">
      <button class="btn" id="buildingRefresh" type="button">Refresh</button>
      <button class="btn primary" id="buildingStartBtn" type="button">Start</button>
      <button class="btn" id="buildingResolveBtn" style="display:none;" type="button">Resolve</button>
    </div>
  </div>
</div>

<!-- Quests modal (STARY ‚Äì fallback Daily) -->
<div class="sheet-back" id="questsBack">
  <div class="sheet-card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700;">Daily Quests</div>
      <button class="btn" id="closeQuests" type="button">√ó</button>
    </div>
    <div id="questsList" style="margin-top:12px; display:grid; gap:10px;"></div>
    <p style="opacity:.7; font-size:12px; margin-top:10px;">
      Quests resetujƒÖ siƒô codziennie. Klikniƒôcia wykonujƒÖ te same akcje, co w bocie.
    </p>
  </div>
</div>

<!-- NOWY MODAL: Mission Board -->
      <div id="qBack" class="q-modal" role="dialog" aria-modal="true" aria-label="Mission Board">
        <div class="q-modal-body">
          <div class="q-modal-head">
            <h3 class="q-title">Mission Board</h3>
            <div class="q-head-actions">
              <button class="q-btn q-btn-ghost" id="qRefresh" type="button" title="Refresh">‚Üª</button>
              <button class="q-btn" id="qClose" type="button" title="Close">√ó</button>
            </div>
          </div>
          <div id="qStatus" class="q-status">Ready</div>
          <div id="qTabs" class="q-filters" role="tablist" aria-label="Quest categories">
            <button class="q-tab q-tab--on" data-tab="all" role="tab" aria-selected="true">All <span data-count="all">0</span></button>
            <button class="q-tab" data-tab="daily" role="tab" aria-selected="false">Daily <span data-count="daily">0</span></button>
            <button class="q-tab" data-tab="repeatable" role="tab" aria-selected="false">Repeatable <span data-count="repeatable">0</span></button>
            <button class="q-tab" data-tab="story" role="tab" aria-selected="false">Story <span data-count="story">0</span></button>
            <button class="q-tab" data-tab="bounties" role="tab" aria-selected="false">Bounties <span data-count="bounties">0</span></button>
          </div>
          <div id="qState" class="q-filters" aria-label="Quest state filters">
            <button class="q-tab q-tab--on" data-state="any">All</button>
            <button class="q-tab" data-state="ready">Ready</button>
            <button class="q-tab" data-state="accepted">Accepted</button>
            <button class="q-tab" data-state="available">Available</button>
            <button class="q-tab" data-state="cooldown">Cooldown</button>
          </div>
          <div id="qList" class="quest-board"></div>
        </div>
      </div>

<!-- === FAQ MODAL (nowy) === -->
<div id="faqModal" class="faq-modal" role="dialog" aria-modal="true" aria-labelledby="faqTitle" hidden>
  <div class="faq-backdrop" data-close></div>
  <div class="faq-sheet" role="document">
    <header class="faq-header">
      <h2 id="faqTitle">Alpha Husky ‚Äî FAQ</h2>
      <button class="faq-close" data-close aria-label="Close FAQ">‚úï</button>
    </header>

    <div class="faq-toolbar">
      <input id="faqSearch" type="search" placeholder="Search FAQ‚Ä¶" autocomplete="off" />
      <div id="faqTabs" class="faq-tabs" role="tablist" aria-label="FAQ Sections"></div>
    </div>

    <div id="faqList" class="faq-list" role="region" aria-live="polite"></div>

    <footer class="faq-footer">
      <button class="faq-copylink" id="faqCopyLink" type="button" title="Copy link to this FAQ view">Copy link</button>
      <span class="faq-hint">Tip: type to filter. Tap a question to expand.</span>
    </footer>
  </div>
</div>

<!-- Floating FAQ button (bottom-left, kontra Quests po prawej) -->
<button id="fabFaq" class="fab-faq" type="button" aria-label="Open FAQ">
  <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm0 15.25a1.25 1.25 0 1 1 0 2.5 1.25 1.25 0 0 1 0-2.5zM12 6a4 4 0 0 1 4 4c0 1.6-1.05 2.7-2.2 3.48-.42.29-.8.55-.98.82-.18.26-.27.55-.27.9v.3h-2v-.35c0-.74.19-1.36.56-1.86.37-.5.9-.88 1.54-1.32C13.4 11.32 14 10.77 14 10a2 2 0 0 0-4 0H8a4 4 0 0 1 4-4z"/>
  </svg>
  <span>FAQ</span>
</button>

<!-- Floating launcher (üìú) -->
<button id="quests-launcher" class="q-launcher" type="button" aria-label="Open Mission Board" title="Quests">üìú</button>
<div class="fallback" id="fallback">
  <div>
    <p>Open this page inside Telegram WebApp for full functionality.</p>
    <p>Go to <strong>Alpha Husky</strong> bot and tap <em>Open</em>.</p>
  </div>
</div>
</div>

  <!-- 1) SDK Telegrama -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- 2) Globalny endpoint API i wersja -->
  <script>
    window.API_BASE = "https://api.alphahusky.win";
    window.WEBAPP_VER = "2025-11-19c";
  </script>

  <!-- 3) Modu≈Çy JS ≈Çadowane w ustalonej kolejno≈õci -->
  <script>
    (function(v){
      var s = document.createElement('script');
      s.src = 'js/combat.js?v=' + encodeURIComponent(v || 'dev');
      s.async = false;
      document.head.appendChild(s);
    })(window.WEBAPP_VER);
  </script>
  <script>
    (function(v){
      var s = document.createElement('script');
      s.src = 'js/fortress.js?v=' + encodeURIComponent(v || 'dev');
      s.async = false;
      document.head.appendChild(s);
    })(window.WEBAPP_VER);
  </script>
  <script>
    (function(v){
      var s=document.createElement('script');
      s.src='js/dojo.js?v='+encodeURIComponent(v||'dev');
      s.defer=true;
      document.head.appendChild(s);
    })(window.WEBAPP_VER);
  </script>

  <!-- 4) G≈Ç√≥wny skrypt aplikacji -->
  <script>
    const DEBUG_UI = true;
    function dbg(msg){ try{ if(!DEBUG_UI) return; const d=document.getElementById('dbg'); d.style.display='block'; d.textContent=msg; }catch(_){} }
    function api(path){ const b = (window.API_BASE || ""); return b ? (b + path) : path; }

    const start = () => {
      try {
        dbg('boot‚Ä¶');

        window.addEventListener('error', e => {
          dbg('ERR: '+(e?.message||'error'));
          try { window.Telegram?.WebApp?.showAlert?.("JS error: " + e.message); } catch(_) {}
          console.error(e);
        });

        const setVh = () => document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
        setVh(); window.addEventListener('resize', setVh);

        const nativeTg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        let tg = nativeTg;

        const $  = sel => document.querySelector(sel);
        const $$ = sel => Array.from(document.querySelectorAll(sel));

        if (!tg) {
          const fb = $("#fallback"); if (fb) fb.style.display = "flex";
          dbg('Open inside Telegram');
        }

        tg?.ready?.(); tg?.expand?.();
        tg?.BackButton?.show?.();
        tg?.BackButton?.onClick?.(() => { if (tg.close) try{ tg.close(); }catch(_){}});

        const setVar = (name, value) => document.documentElement.style.setProperty(name, value);
        const hexToRgba = (hex, a) => {
          if(!hex) return `rgba(0,0,0,${a})`;
          const h = (''+hex).replace('#',''); const full = h.length===3 ? h.split('').map(c=>c+c).join('') : h.slice(0,6);
          const n = parseInt(full,16); const r=(n>>16)&255, g=(n>>8)&255, b=n&255; return `rgba(${r},${g},${b},${a})`;
        };
        const p = tg?.themeParams || {};
        try{
          setVar('--glass', p.secondary_bg_color ? hexToRgba(p.secondary_bg_color, 0.45) : 'rgba(0,0,0,.45)');
          setVar('--stroke', p.hint_color ? hexToRgba(p.hint_color, 0.22) : 'rgba(255,255,255,.18)');
          if (p.text_color) setVar('--txt', p.text_color);
        }catch(_){}
        tg?.onEvent?.('themeChanged', () => {
          const p2 = tg?.themeParams || {};
          try{
            setVar('--glass', p2.secondary_bg_color ? hexToRgba(p2.secondary_bg_color, 0.45) : 'rgba(0,0,0,.45)');
            setVar('--stroke', p2.hint_color ? hexToRgba(p2.hint_color, 0.22) : 'rgba(255,255,255,.18)');
            if (p2.text_color) setVar('--txt', p2.text_color);
          }catch(_){}
        });

        function setPlayerLabel(lbl){
          const name = lbl || 'Alpha Husky';

          // Nick w topbarze
          const el = document.getElementById('player');
          if (el) el.textContent = name;

          // Nick pod centralnym oknem skina (je≈õli istnieje)
          const heroName = document.getElementById('heroName');
          if (heroName) heroName.textContent = name;
        }

        const unsafeUser = tg?.initDataUnsafe?.user;
        if (unsafeUser) {
          const fallbackName = unsafeUser.username
            ? '@' + unsafeUser.username
            : (unsafeUser.first_name || 'Player');
          setPlayerLabel(fallbackName);
        }

        const init_data = window.Telegram?.WebApp?.initData || "";

        tg?.MainButton?.setText?.("Quests");
        tg?.MainButton?.onClick?.(() => { (window.Quests && window.Quests.open) ? window.Quests.open() : openQuests(); });
        tg?.MainButton?.show?.();

        const DEV_DEBUG = false;
        let _busy = false;

        async function sendAction(action, payload = {}) {
          const unsafe = tg?.initDataUnsafe || {};
          const hasQuery = !!unsafe.query_id;

          if (hasQuery) {
            try {
              const res = await apiPost("/webapp/action", { action, payload });
              if (res.ok) { try { tg?.close?.(); } catch(_){} }
              else { tg?.showAlert?.(res.reason || "Action failed."); }
            } catch (e) {
              tg?.showAlert?.("Network error (inline). Try again.");
              console.error(e);
            }
          } else {
            try {
              if (_busy) return;
              _busy = true; setTimeout(() => (_busy = false), 300);
              tg?.HapticFeedback?.impactOccurred?.("light");
              const data = { action, payload: { userId: (tg?.initDataUnsafe?.user?.id), ...payload } };
              if (DEV_DEBUG && tg?.showAlert) tg.showAlert(action + "\n" + JSON.stringify(payload));
              tg?.sendData?.(JSON.stringify(data));
            } catch (err) {
              tg?.showAlert?.("Send failed. Try again."); console.error(err);
            }
          }
        }

        async function apiPost(path, payload){
          const init_data = window.Telegram?.WebApp?.initData || "";
          const headers = { "Content-Type": "application/json" };
          if (init_data) headers.Authorization = `Bearer ${init_data}`;
          const res = await fetch(api(path), {
            method: "POST",
            headers,
            body: JSON.stringify({ init_data, ...(payload||{}) })
          });
          const data = await res.json().catch(()=> ({}));
          if (!res.ok) throw Object.assign(new Error(data.reason || res.statusText), { status: res.status, data });
          return data;
        }

        window.S = window.S || {};
        window.S.apiPost = apiPost;

        window.Fortress?.init?.({ apiPost, tg, dbg });
        window.Dojo?.init?.({ apiPost, tg, dbg });
        window.Quests?.init?.({ apiPost, tg, dbg });

        setTimeout(() => { window.Combat?.init?.({ container: document.body }); }, 100);

        /* ===== MAP / STATE ===== */
        const mapBack = document.getElementById("mapBack");
        const mapRoot = document.getElementById("map");
        const pinsEl = document.getElementById("pins") || createPinsLayer(mapRoot);
        const pathsSVG= document.getElementById("pathsSVG") || createPathsLayer(mapRoot);
        let DATA = null;
        const VIEW_W = 1000, VIEW_H = 562;
        let regionsUnlocked = new Set();
        let keys = new Set();
        let fragments = {};
        let PLAYER_STATE = null;
        let PROFILE = null;

        function createPathsLayer(root){
          const layer = document.createElement("div");
          layer.className = "paths-layer";
          const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
          svg.setAttribute("id","pathsSVG");
          svg.setAttribute("viewBox","0 0 1000 562");
          svg.setAttribute("preserveAspectRatio","xMidYMid meet");
          layer.appendChild(svg); root.appendChild(layer); return svg;
        }
        function createPinsLayer(root){
          const layer = document.createElement("div");
          layer.className = "pins"; layer.id = "pins";
          root.appendChild(layer); return layer;
        }

        function resolveLabelCollisions(){
          const chips = Array.prototype.slice.call(document.querySelectorAll('.pins .chip'));
          chips.sort((a,b)=>a.getBoundingClientRect().top - b.getBoundingClientRect().top);
          for (let i=1;i<chips.length;i++){
            const prev = chips[i-1].getBoundingClientRect();
            const cur = chips[i].getBoundingClientRect();
            const overlap = (prev.bottom + 6) - cur.top;
            if (overlap > 0) {
              const current = chips[i].style.transform || "translateX(-50%)";
              chips[i].style.transform = current + ` translateY(${overlap}px)`;
            }
          }
          const mapRect = mapRoot.getBoundingClientRect();
          chips.forEach(ch => {
            const r = ch.getBoundingClientRect();
            const leftOverflow = mapRect.left + 8 - r.left;
            const rightOverflow = r.right - (mapRect.right - 8);
            if (leftOverflow > 0) ch.style.marginLeft = (leftOverflow)+"px";
            if (rightOverflow > 0) ch.style.marginLeft = (-rightOverflow)+"px";
          });
        }

        async function loadMapData(){
          try{
            const v = window.WEBAPP_VER || 'dev';
            DATA = await fetch(`map.json?v=${encodeURIComponent(v)}`, { cache: 'no-store' }).then(r => r.json());
          }catch(e){
            console.error('map.json load error', e);
            DATA = null;
          }
          regionsUnlocked = new Set((DATA && DATA.defaults && DATA.defaults.regionsUnlocked) || ['chain']);
          keys = new Set((DATA && DATA.defaults && DATA.defaults.keys) || []);
          fragments = Object.assign({}, (DATA && DATA.defaults && DATA.defaults.fragments) || {});
          window.FORTRESS_ENEMIES = (DATA && DATA.fortress && DATA.fortress.enemies) || {};
          window.DATA = DATA;
          renderMap();
        }

        function applyStateToMap(){
          if (!PLAYER_STATE) return;
          if (Array.isArray(PLAYER_STATE.regionsUnlocked)) regionsUnlocked = new Set(PLAYER_STATE.regionsUnlocked);
          if (typeof PLAYER_STATE.keyFragments === "number") fragments.map_key_fragment = PLAYER_STATE.keyFragments;
        }

        function updateUnlockProgress(){
          const el = document.getElementById('unlockProgress');
          const cfg = DATA && DATA.ui && DATA.ui.unlockTarget;
          if (!el || !cfg) { if (el) el.style.display = 'none'; return; }
          const have = (fragments[cfg.item] || 0), need = cfg.required || 0;
          const fill = Math.max(0, Math.min(100, Math.round((have / Math.max(1,need)) * 100)));
          const regName = (DATA && DATA.regions && DATA.regions[cfg.region] && DATA.regions[cfg.region].name) || 'Region';
          document.getElementById('unlockLabel').textContent = regName;
          document.getElementById('unlockFill').style.width = fill + '%';
          document.getElementById('unlockCount').textContent = `${have}/${need}`;
          el.style.display = 'flex';
        }

        function renderTopbar(){
          const s = PLAYER_STATE && PLAYER_STATE.stats;
          const lvlFromState = (s && typeof s === 'object' && (s.level ?? 1)) || 1;
          const lvl = (PROFILE && typeof PROFILE.level === 'number') ? PROFILE.level : lvlFromState;
          const bones = s && typeof s === 'object' ? (s.bones ?? 0) : 0;

          const fac = document.getElementById('faction');
          if (fac) {
            const base = (PROFILE && PROFILE.faction)
              ? PROFILE.faction
              : (fac.dataset.base || fac.textContent || 'PACK');
            if (!fac.dataset.base) fac.dataset.base = base;
            fac.textContent = `${base} ‚Ä¢ Lv ${lvl} ‚Ä¢ ${bones}ü¶¥`;
          }

          const heroLevel = document.getElementById('heroLevel');
          if (heroLevel) heroLevel.textContent = `Lv.${lvl}`;
        }

        function applyProfileSkin(skin){
          const skinImg = document.getElementById('player-skin');
          if (!skinImg || !skin) return;

          if (typeof skin === 'string') {
            skinImg.src = skin;
            skinImg.alt = 'Active skin';
            return;
          }

          if (skin.img) skinImg.src = skin.img;
          if (skin.name) skinImg.alt = skin.name;
        }

        async function loadProfile(){
          try {
            const out = await apiPost("/webapp/profile", {});
            if (!out) return;
            // pozwalamy na dwa kszta≈Çty: { ok, profile:{...} } albo bezpo≈õrednio dane
            const p = out.profile || out;

            PROFILE = PROFILE || {};
            if (typeof p.level === "number") PROFILE.level = p.level;
            else if (p.stats && typeof p.stats.level === "number") PROFILE.level = p.stats.level;

            if (p.nickname || p.name){
              PROFILE.nickname = p.nickname || p.name;
              setPlayerLabel(PROFILE.nickname);
            }

            if (p.faction) PROFILE.faction = p.faction;

            PROFILE.skin = p.skin || p.activeSkin || PROFILE.skin || null;
            if (PROFILE.skin) applyProfileSkin(PROFILE.skin);

            renderTopbar();
          } catch (e){
            console.warn("profile load failed", e);
          }
        }

        async function loadPlayerState(){
          try {
            const state = await apiPost("/webapp/state");
            PLAYER_STATE = state;
            applyStateToMap();

            // 1) Nick z profilu gry
            if (state && state.profile && state.profile.nickname){
              setPlayerLabel(state.profile.nickname);
            }
            // 2) Fallback ‚Äì dane z Telegrama
            else if (state && state.user && !state.user.is_bot) {
              const lbl = state.user.username
                ? '@' + state.user.username
                : (state.user.first_name || 'Player');
              setPlayerLabel(lbl);
            }

            // 3) LVL/Bones ‚Üí topbar + hero HUD
            renderTopbar();

            if (mapBack.style.display === "flex" && DATA) {
              renderMap(); updateUnlockProgress();
            }
          } catch (e) {
            console.warn("state load failed", e);
          }
        }

        function isRegionUnlocked(regionId){
          const reg = DATA && DATA.regions && DATA.regions[regionId];
          if (!reg) return true;
          if (regionsUnlocked.has(regionId)) return true;
          const u = reg.unlock || { type: 'free' };
          if (u.type === 'free') return true;
          if (u.type === 'key') return !!(u.id && keys.has(u.id));
          if (u.type === 'fragments'){
            if (u.combineInto && keys.has(u.combineInto)) return true;
            const have = fragments[u.item] || 0;
            return have >= (u.required || Infinity);
          }
          return false;
        }

        const toXY = (xp,yp) => ({ x: Math.round((xp/100)*VIEW_W), y: Math.round((yp/100)*VIEW_H) });

        function drawPaths(){
          if (!DATA) return;
          pathsSVG.innerHTML = '';
          for (const p of (DATA.paths || [])){
            const locked = p.lockForRegion && !isRegionUnlocked(p.lockForRegion);
            const ptsStr = (p.points||[]).map(([xp,yp])=>{ const {x,y}=toXY(xp,yp); return `${x},${y}`; }).join(' ');
            if (!locked && p.emphasis){
              const glow = document.createElementNS('http://www.w3.org/2000/svg','polyline');
              glow.setAttribute('points', ptsStr);
              glow.setAttribute('class', 'path glow');
              pathsSVG.appendChild(glow);
            }
            const poly = document.createElementNS('http://www.w3.org/2000/svg','polyline');
            poly.setAttribute('points', ptsStr);
            poly.setAttribute('class', 'path' + (locked ? ' locked' : ''));
            poly.setAttribute('data-id', p.id);
            pathsSVG.appendChild(poly);
          }
        }

        function renderPins(){
          if (!DATA) return;
          pinsEl.innerHTML = '';
          for (const b of (DATA.nodes || [])){
            const unlocked = isRegionUnlocked(b.region);
            const btn = document.createElement('button');
            btn.className = 'hotspot ' + (unlocked ? 'unlocked' : 'locked');
            btn.style.left = b.x + '%';
            btn.style.top  = b.y + '%';
            btn.title = b.name + (unlocked ? '' : ' (locked)');

            const ring = document.createElement('span'); ring.className = 'ping'; btn.appendChild(ring);
            const img = document.createElement('img'); img.src = b.icon; img.alt = b.name; btn.appendChild(img);
            const chip = document.createElement('div'); chip.className = 'chip'; chip.textContent = b.name; btn.appendChild(chip);

            if (!unlocked){
              const lock = document.createElement('span');
              lock.className = 'lock-badge';
              lock.innerHTML = `<img src="${((DATA.ui && DATA.ui.pin && DATA.ui.pin.badgeLock) || 'images/ui/lock.svg')}" alt="locked">`;
              btn.appendChild(lock);
            }

            btn.addEventListener('click', () => {
              createBurst(parseFloat(btn.style.left), parseFloat(btn.style.top), unlocked);
              if (!unlocked) return openLocked(b);

              if (b.action === 'open_quests') return (window.Quests ? window.Quests.open() : openQuests());

              if (b.action === 'building_enter' && b.buildingId === 'moonlab_fortress' && window.Fortress?.open) {
                return window.Fortress.open();
              }

              if ((b.id === 'testnet_wastes') ||
                  (b.action === 'building_enter' && b.buildingId === 'testnet_wastes_dojo')) {
                if (window.Dojo?.open) return window.Dojo.open();
              }

              if (b.action === 'building_enter' && b.buildingId) return openBuilding(b.buildingId, b.name, b.desc);

              const reg = DATA && DATA.regions && DATA.regions[b.region];
              if (reg && (reg.desc || b.desc)) return openRegionSheet(b, reg);
              return openRegion(b.region);
            });

            pinsEl.appendChild(btn);
          }
          resolveLabelCollisions();
        }

        const canvas = document.getElementById('particlesCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;

        function createBurst(xPercent, yPercent, isUnlocked = true) {
          if (!ctx) return;
          canvas.style.display = 'block';
          canvas.style.opacity = '1';
          const x = (xPercent / 100) * VIEW_W;
          const y = (yPercent / 100) * VIEW_H;
          const particles = [];
          const numParticles = 12;
          const colors = isUnlocked ? ['#00E5FF', '#9B4DFF'] : ['#9483B4'];

          for (let i = 0; i < numParticles; i++) {
            particles.push({
              x, y,
              vx: (Math.random() - 0.5) * 8,
              vy: (Math.random() - 0.5) * 8,
              size: Math.random() * 3 + 1,
              color: colors[Math.floor(Math.random() * colors.length)],
              life: 1,
              decay: Math.random() * 0.02 + 0.01
            });
          }

          let animId;
          function animate() {
            ctx.clearRect(0, 0, VIEW_W, VIEW_H);
            let alive = 0;
            for (let i = 0; i < particles.length; i++){
              const p = particles[i];
              if (!p) continue;
              p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.life -= p.decay;
              if (p.life > 0) {
                alive++;
                ctx.save();
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 8; ctx.shadowColor = p.color; ctx.fill();
                ctx.restore();
              } else {
                particles.splice(i,1); i--;
              }
            }
            if (alive > 0) {
              animId = requestAnimationFrame(animate);
            } else {
              canvas.style.opacity = '0';
              setTimeout(() => { canvas.style.display = 'none'; }, 200);
              if (animId) cancelAnimationFrame(animId);
            }
          }
          animate();
          try { tg?.HapticFeedback?.impactOccurred?.(isUnlocked ? "medium" : "light"); } catch(e) {}
        }

        function renderMap(){ drawPaths(); renderPins(); updateUnlockProgress(); }

        const lockedBack = $("#lockedBack");
        const lockedTitle = $("#lockedTitle");
        const lockedDesc = $("#lockedDesc");
        const lockedForge = $("#lockedForge");
        const lockedShop = $("#lockedShop");
        const lockedAsk = $("#lockedAsk");
        $("#closeLocked")?.addEventListener("click", () => lockedBack.style.display = "none");

        function openLocked(b){
          const reg = DATA && DATA.regions && DATA.regions[b.region];
          const u = (reg && reg.unlock) || {};
          const reason = reg && reg.lockedReason;
          lockedTitle.textContent = `Locked: ${b.name}`;
          let forgeRecipe = null;

          if (u.type === 'fragments'){
            const cur = fragments[u.item] || 0;
            const need = u.required || 0;
            const label = (u.item || '').replace(/key_/g,'').replace(/_/g,' ');
            lockedDesc.innerHTML = reason || `Collect <b>${need} ${label}</b> (<b>${cur}</b> / ${need}) to unlock. Craft into a key in <b>Forge</b> if required.`;
            forgeRecipe = (u.combineInto || u.item) || null;
          } else if (u.type === 'key'){
            const label = (u.id || 'region key').replace(/key_/g,'').replace(/_/g,' ');
            lockedDesc.innerHTML = reason || `Requires <b>${label}</b> to unlock.`;
            forgeRecipe = u.id || null;
          } else {
            lockedDesc.textContent = reason || 'Complete requirements to unlock.';
          }

          lockedShop.onclick = (e) => { e?.preventDefault?.(); sendAction('shop_open', { tab: 'boosts' }); };
          lockedForge.onclick = (e) => { e?.preventDefault?.(); sendAction('forge_open', { recipe: forgeRecipe }); };
          lockedAsk.onclick = (e) => { e?.preventDefault?.(); sendAction('unlock_region', { region: b.region }); };
          lockedBack.style.display = 'flex';
        }

        const regionBack  = document.getElementById('regionBack');
        const regionTitle = document.getElementById('regionTitle');
        const regionDesc  = document.getElementById('regionDesc');
        const btnRegionGo = document.getElementById('regionGo');
        const btnRegionLo = document.getElementById('regionLore');
        document.getElementById('closeRegion')?.addEventListener('click', () => regionBack.style.display='none');

        function openRegionSheet(node, reg){
          regionTitle.textContent = (reg && reg.name) || (node && node.name) || 'Region';
          regionDesc.textContent = (reg && reg.desc) || (node && node.desc) || '';
          btnRegionGo.onclick = () => {
            regionBack.style.display='none';
            if (node?.id === 'testnet_wastes' && window.Dojo?.open) { window.Dojo.open(); return; }
            sendAction('region_open', { region: node.region, nodeId: node.id });
          };
          btnRegionLo.onclick = () => { regionBack.style.display='none'; sendAction('lore_open', { region: node.region }); };
          regionBack.style.display = 'flex';
        }

        const bBack   = $("#buildingBack");
        const bTitle  = $("#buildingTitle");
        const bDesc   = $("#buildingDesc");
        const bStatus = $("#buildingStatus");
        const bTimerW = $("#buildingTimerWrap");
        const bTimer  = $("#buildingTimer");
        const bRoutesW= $("#buildingRoutesWrap");
        const bRoute  = $("#buildingRoute");
        const bBtnRef = $("#buildingRefresh");
        const bBtnStart=$("#buildingStartBtn");
        const bBtnRes = $("#buildingResolveBtn");

        $("#closeBuilding")?.addEventListener("click", () => { bBack.style.display='none'; stopBuildingTicker(); });

        const AUTO_RESOLVE_ON_READY = true;
        const READY_GRACE_MS = 2000;
        const RETRY_INTERVAL_MS = 1200;
        const MAX_RESOLVE_RETRIES = 5;

        let CURRENT_BID = null;
        let ticker = null;
        function stopBuildingTicker(){ if (ticker){ clearInterval(ticker); ticker=null; } }
        function startBuildingTicker(endTs){
          stopBuildingTicker();
          const tick = () => {
            const left = Math.ceil(endTs - Date.now()/1000);
            bTimer.textContent = formatLeft(Math.max(0,left));
            if (left <= 0) {
              stopBuildingTicker();
              verifyReadyAndMaybeResolve();
            }
          };
          tick();
          ticker = setInterval(tick, 1000);
        }
        function formatLeft(sec){
          const m = Math.floor(sec/60), s = sec%60;
          return (m>0? m+"m ":"") + s + "s";
        }

        async function openBuilding(bid, name, desc){
          CURRENT_BID = bid;
          bTitle.textContent = name || "Building";
          bDesc.textContent = desc || "";
          bBack.style.display = 'flex';
          await loadBuildingState();
        }

        async function loadBuildingState(){
          if (!CURRENT_BID) return;
          try{
            const st = await apiPost("/webapp/building/state", { buildingId: CURRENT_BID });
            bTitle.textContent = st.name || bTitle.textContent;
            bDesc.textContent  = st.desc || bDesc.textContent;

            bRoutesW.style.display = (st.routes && st.routes.length) ? 'block' : 'none';
            bRoute.innerHTML = '';
            if (st.routes && st.routes.length){
              for (const r of st.routes){
                const opt = document.createElement('option');
                opt.value = r.id; opt.textContent = r.label || r.id;
                bRoute.appendChild(opt);
              }
            }

            if (st.active){
              const left = Math.max(0, Math.floor(st.timeLeftSec || 0));
              bStatus.textContent = "Active";
              bBtnStart.style.display = "none";
              bBtnRes.style.display = "none";
              bTimerW.style.display = "block";
              if (left > 0){
                startBuildingTicker(Math.floor(Date.now()/1000) + left);
              } else {
                verifyReadyAndMaybeResolve();
              }
            } else {
              bStatus.textContent = "Idle";
              bBtnStart.style.display = "inline-block";
              bBtnRes.style.display = "none";
              bTimerW.style.display = "none";
              stopBuildingTicker();
            }
          }catch(e){
            console.warn(e); dbg('building/state fail');
            try { window.Telegram?.WebApp?.showAlert?.("Failed to load building state"); } catch(_){}
          }
        }

        async function verifyReadyAndMaybeResolve(){
          bStatus.textContent = "Finalizing‚Ä¶";
          bBtnRes.style.display = "none";
          bTimerW.style.display = "none";
          try{
            const st = await apiPost("/webapp/building/state", { buildingId: CURRENT_BID });
            if (st.active && (st.timeLeftSec||0) > 0){
              bStatus.textContent = "Active";
              bBtnStart.style.display = "none";
              bBtnRes.style.display = "none";
              bTimerW.style.display = "block";
              startBuildingTicker(Math.floor(Date.now()/1000) + st.timeLeftSec);
              return;
            }
          }catch(_){}

          if (AUTO_RESOLVE_ON_READY){
            setTimeout(() => resolveRun(MAX_RESOLVE_RETRIES, /*silentRetries=*/true), READY_GRACE_MS);
          } else {
            bStatus.textContent = "Ready";
            bBtnRes.style.display = "inline-block";
          }
        }

        /* helper do formatowania nagr√≥d z budynk√≥w (w tym item shards) */
        function formatBuildingRewards(rewardsRaw) {
          const rw = rewardsRaw || {};
          const lines = [];

          if (rw.scrap)      lines.push(`+${rw.scrap} Scrap`);
          if (rw.rune_dust)  lines.push(`+${rw.rune_dust} Rune Dust`);
          if (rw.bones)      lines.push(`+${rw.bones} Bones`);
          if (rw.fragment)   lines.push(`+1 Map Key Fragment`);

          // item shards z The Chain Gate (opcjonalne pole)
          if (rw.shards && rw.shards.amount) {
            const slot = rw.shards.slot || "item";
            const amt  = rw.shards.amount;
            const label = (slot + " shards")
              .replace(/_/g, " ")
              .replace(/\b\w/g, c => c.toUpperCase()); // helmet_shards ‚Üí Helmet Shards
            lines.push(`+${amt} ${label}`);
          }

          return lines;
        }

        async function resolveRun(maxRetries=0, silentRetries=false){
          if (!CURRENT_BID) return false;
          for (let i=0; i<=maxRetries; i++){
            try{
              const out = await apiPost("/webapp/building/resolve", { buildingId: CURRENT_BID });
              const rw = out?.rewards || {};
              const lines = formatBuildingRewards(rw);
              try { tg?.HapticFeedback?.notificationOccurred?.("success"); } catch(_){}
              tg?.showAlert?.(lines.length ? `Rewards:\n${lines.join(", ")}` : "No rewards this time.");
              await loadPlayerState();
              await loadBuildingState();
              return true;
            }catch(e){
              const reason = (e && e.data && e.data.reason) || e?.message || "";
              const R = String(reason).toUpperCase();
              const isNotReady = R.includes("NOT_READY");
              if (isNotReady && i < maxRetries){
              await new Promise(r => setTimeout(r, RETRY_INTERVAL_MS));
              continue;
              }
              if (!silentRetries) tg?.showAlert?.(reason || "Resolve failed");
              bStatus.textContent = "Ready";
              bBtnRes.style.display = "inline-block";
              return false;
            }
          }
          bStatus.textContent = "Ready";
          bBtnRes.style.display = "inline-block";
          return false;
        }

        bBtnRef && bBtnRef.addEventListener("click", loadBuildingState);
        bBtnStart && bBtnStart.addEventListener("click", async () => {
          if (!CURRENT_BID) return;
          try{
            const route = bRoute && bRoute.value || "";
            const out = await apiPost("/webapp/building/start", { buildingId: CURRENT_BID, route });
            if (out && out.endsAt){
              bStatus.textContent = "Active";
              bBtnStart.style.display = "none";
              bBtnRes.style.display = "none";
              bTimerW.style.display = "block";
              startBuildingTicker(out.endsAt);
            } else if (out && out.minutes){
              const ends = Math.floor(Date.now()/1000) + (out.minutes*60);
              bStatus.textContent = "Active";
              bBtnStart.style.display = "none";
              bBtnRes.style.display = "none";
              bTimerW.style.display = "block";
              startBuildingTicker(ends);
            }
          }catch(e){
            const msg = (e && e.data && e.data.reason) || "Start failed";
            try { window.Telegram?.WebApp?.showAlert?.(msg); } catch(_){}
          }
        });
        bBtnRes && bBtnRes.addEventListener("click", () => resolveRun());

        /* === BUTTONS / ACTIONS === */
        const actions = {
          ".btn.avatar": () => sendAction("avatar_open"),          // Avatar ‚Äì wraca do bota
          ".btn.skins":  () => openSkinsModal(),                   // Skins ‚Äì WebApp modal
          ".btn.map": () => {
            mapBack.style.display = "flex";
            if (!DATA) loadMapData();
            loadPlayerState();
          },
          ".btn.mission": () => sendAction("mission_open", { level: 1 }),
          ".btn.inventory": () => sendAction("cmd", { name: "inventory" }),
          ".btn.char": () => sendAction("char_open"),
          ".btn.shop": () => sendAction("shop_open"),
          ".btn.pets": () => sendAction("pets_open"),
          ".btn.equipped": () => sendAction("cmd", { name: "equipped" }),
          ".btn.keys": () => sendAction("cmd", { name: "keys" }),
          ".btn.feed": () => sendAction("cmd", { name: "feed" }),
          ".btn.mystats": () => sendAction("cmd", { name: "mystats" }),
          ".btn.mypets": () => sendAction("cmd", { name: "mypets" }),
          ".btn.profile": () => sendAction("cmd", { name: "profile" }),
          ".btn.howlboard": () => openBoard(),
        };
        Object.entries(actions).forEach(([sel, fn]) => {
          const el = document.querySelector(sel);
          el && el.addEventListener('click', (e) => { e.preventDefault(); try{ fn(e); }catch(err){ console.error(err); dbg('ERR: '+(err?.message||err)); } });
        });
        document.getElementById("closeMap")?.addEventListener("click", () => { mapBack.style.display = "none"; });

        function openRegion(region, nodeId) { sendAction("region_open", { region, nodeId }); }

        mapRoot?.addEventListener("click", (e) => {
          if (e.target !== mapRoot) return;
          const r = mapRoot.getBoundingClientRect();
          const x = ((e.clientX - r.left)/r.width*100).toFixed(1);
          const y = ((e.clientY - r.top) /r.height*100).toFixed(1);
          console.log("coords:", x, y);
        });

       /* === SKINS UI === */
const avatarBack = document.getElementById('avatarBack');
const skinCanvas = document.getElementById('skinCanvas');
const skinCtx = skinCanvas ? skinCanvas.getContext('2d') : null;
const skinDesc = document.getElementById('skinDesc');
const closeAvatar = document.getElementById('closeAvatar');
const equipSkin = document.getElementById('equipSkin');
const shareSkin = document.getElementById('shareSkin');
const skinButtonsWrap = document.getElementById('skinButtons');
let _skins = [];
let _activeSkinKey = "";

avatarBack?.addEventListener('click', (e) => { if (e.target === avatarBack) avatarBack.style.display = 'none'; });
closeAvatar?.addEventListener('click', () => { avatarBack.style.display = 'none'; });

function renderSkinPreview(imgUrl, name){
  if (!skinCtx) return;
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.src = imgUrl;
  img.onload = () => {
    skinCtx.clearRect(0, 0, skinCanvas.width, skinCanvas.height);
    const scaleX = skinCanvas.width / img.width;
    const scaleY = skinCanvas.height / img.height;
    const scale = Math.min(scaleX, scaleY);
    const drawW = img.width * scale;
    const drawH = img.height * scale;
    const offsetX = (skinCanvas.width - drawW) / 2;
    const offsetY = (skinCanvas.height - drawH) / 2;
    skinCtx.drawImage(img, offsetX, offsetY, drawW, drawH);
  };
  img.onerror = () => {
    skinCtx.clearRect(0,0,skinCanvas.width, skinCanvas.height);
    skinCtx.fillStyle = '#333'; skinCtx.fillRect(0,0,skinCanvas.width, skinCanvas.height);
    skinCtx.fillStyle = '#fff'; skinCtx.font = '20px Arial'; skinCtx.textAlign = 'center';
    skinCtx.fillText('Skin not found', skinCanvas.width/2, skinCanvas.height/2);
  };
  skinDesc.textContent = `${name} ‚Äî Flex your alpha! üê∫`;
}

function buildSkinButtons(skins, active){
  if (!skinButtonsWrap) return;
  skinButtonsWrap.innerHTML = "";
  skins.forEach(s => {
    const b = document.createElement('button');
    b.className = 'btn skin-btn' + (s.key === active ? ' active' : '');
    b.type = 'button';
    b.textContent = s.name || s.key;
    b.dataset.skin = s.key;
    b.addEventListener('click', () => {
      $$(`#skinButtons .skin-btn`).forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      _activeSkinKey = s.key;
      renderSkinPreview(s.img, s.name || s.key);
      try { tg?.HapticFeedback?.impactOccurred?.('light'); } catch(_){}
    });
    skinButtonsWrap.appendChild(b);
  });

  const first = skins.find(s => s.key === active) || skins[0];
  if (first){
    _activeSkinKey = first.key;
    renderSkinPreview(first.img, first.name || first.key);
    const btn = skinButtonsWrap.querySelector(`[data-skin="${_activeSkinKey}"]`);
    if (btn) btn.classList.add('active');
  } else {
    skinCtx?.clearRect(0,0,skinCanvas.width, skinCanvas.height);
    skinDesc.textContent = 'No skins available yet.';
  }
}

async function openSkinsModal(){
  try{
    const out = await apiPost("/webapp/skins", {});
    if (!out || !out.ok) throw new Error(out?.reason || "skins get failed");
    _skins = Array.isArray(out.skins) ? out.skins : [];
    _activeSkinKey = out.active || "";
    buildSkinButtons(_skins, _activeSkinKey || "");
    avatarBack.style.display = 'flex';
  }catch(e){
    console.warn(e);
    tg?.showAlert?.("Failed to load skins.");
  }
}

equipSkin?.addEventListener('click', async () => {
  const key = (skinButtonsWrap.querySelector('.skin-btn.active')?.dataset.skin) || _activeSkinKey || "";
  if (!key) { tg?.showAlert?.("Pick a skin first"); return; }
  try{
    const out = await apiPost("/webapp/skins/equip", { skin: key });
    if (!out || !out.ok) throw new Error(out?.reason || "equip failed");
    tg?.showAlert?.("Skin equipped!");
    avatarBack.style.display = 'none';
    // od≈õwie≈º player-card z backendowego profilu
    loadProfile();
  }catch(e){
    console.warn(e);
    tg?.showAlert?.(e?.message || "Equip failed");
  }
});

shareSkin?.addEventListener('click', () => {
  if (!tg?.shareToStory || !skinCanvas?.toBlob) { tg?.showAlert?.("Sharing not supported"); return; }
  const key = (skinButtonsWrap.querySelector('.skin-btn.active')?.dataset.skin) || _activeSkinKey || "skin";
  skinCanvas.toBlob((blob) => {
    tg?.shareToStory?.(blob, { text: `Flex my ${key} Skin in @The_Alpha_Husky! üê∫`, widgetLink: 'https://t.me/Alpha_husky_bot' });
    try { tg?.HapticFeedback?.impactOccurred?.('medium'); } catch(_){}
  }, 'image/png');
});

        /* === Howlboard === */
        const boardBack = document.getElementById("boardBack");
        const closeBoard = document.getElementById("closeBoard");
        function openBoard(){ boardBack.style.display = "flex"; }
        closeBoard?.addEventListener("click", () => boardBack.style.display = "none");
        $$(".tab").forEach(t => {
          t.addEventListener("click", () => {
            $$(".tab").forEach(x => x.classList.toggle("active", x===t));
            const sort = t.getAttribute("data-sort");
            sendAction("cmd", { name: "howlboard", args: [sort] });
            boardBack.style.display = "none";
          });
        });

        /* Daily fallback (stary modal) */
        const questsBack = document.getElementById("questsBack");
        const questsList = document.getElementById("questsList");
        document.getElementById("closeQuests")?.addEventListener("click", () => {
          questsBack.style.display = "none";
        });
        function openQuests(){
          questsBack.style.display = "flex";
          refreshQuests();
        }
        async function refreshQuests(){
          questsList.innerHTML = "";
          try{
            const s = await apiPost("/webapp/daily/state");
            if (!s.ok) throw new Error(s.error || "state failed");
            const rows = [];
            function card(label, q, raid){
              const wrap = document.createElement("div");
              wrap.style.cssText = "display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px;border:1px solid var(--ring);border-radius:12px;background:rgba(0,0,0,.4)";
              wrap.innerHTML = `
                <div>
                  <div style="font-weight:700">${label}</div>
                  <div style="opacity:.85">${q ? q.desc : "‚Äî"}</div>
                  <div style="opacity:.7;font-size:12px;margin-top:4px;">Reward: ${q ? q.rewardText : "-"}</div>
                </div>
                <div class="qa"></div>
              `;
              const act = wrap.querySelector(".qa");
              if (!q){
                act.innerHTML = `<span style="opacity:.6">No quest</span>`;
                return wrap;
              }
              if (q.availableActions.length === 0){
                act.innerHTML = `<span style="opacity:.6">${q.claimed ? "Claimed ‚úÖ" : (q.done ? "Completed ‚úÖ" : "")}</span>`;
              } else {
                q.availableActions.forEach(a => {
                  const b = document.createElement("button");
                  b.className = "btn";
                  b.textContent = a === "daily_claim" ? "Claim" : (a === "daily_raid" ? "RAID" : "Do it");
                  b.addEventListener("click", () => triggerDaily(a, !!raid));
                  act.appendChild(b);
                });
              }
              return wrap;
            }
            if (s.normal) rows.push(card("Daily", s.normal, false));
            if (s.raid)   rows.push(card("Raid",  s.raid,   true));
            rows.forEach(r => questsList.appendChild(r));
          }catch(e){
            console.warn(e);
            questsList.innerHTML = `<div style="opacity:.8">Failed to load daily state.</div>`;
          }
        }
        async function triggerDaily(action, raid){
          const unsafe = tg?.initDataUnsafe || {};
          if (unsafe.query_id) {
            try {
              const ans = await apiPost("/webapp/daily/action", { action, raid });
              if (!ans.ok) throw new Error(ans.error || "Action failed");
              if (ans.message) tg?.showAlert?.(ans.message);
            } catch (e) {
              console.warn(e);
              tg?.showAlert?.("Action failed. Try again.");
            }
          } else {
            tg?.sendData?.(JSON.stringify({ action: "daily_action", payload: { action, raid } } ));
          }
          refreshQuests();
        }

        /* Routing z URL */
        const qs = new URLSearchParams(location.search);
        const sectionParam = (qs.get("section") || "").toLowerCase();
        const toastParam = qs.get("toast");
        if (toastParam && tg?.showAlert) tg.showAlert(toastParam.replace(/_/g,' '));
        function showSection(name){
          switch(name){
            case "map":
              mapBack.style.display = "flex";
              if (!DATA) loadMapData();
              loadPlayerState();
              break;
            case "quests":
              (window.Quests && window.Quests.open) ? window.Quests.open() : openQuests();
              break;
            case "mission":
              sendAction("mission_open", { level: 1 });
              break;
            case "inventory":
              sendAction("cmd", { name: "inventory" });
              break;
            case "shop":
              sendAction("shop_open");
              break;
            case "profile":
              sendAction("cmd", { name: "profile" });
              break;
            case "pets":
              sendAction("pets_open");
              break;
            case "fortress":
              if (window.Fortress?.open) window.Fortress.open();
              else tg?.showAlert?.("Fortress is loading. Try again in a moment.");
              break;
            default:
              break;
          }
        }

        loadPlayerState();
        loadProfile();
        if (sectionParam) { setTimeout(() => showSection(sectionParam), 80); }

        document.getElementById('quests-launcher')?.addEventListener('click', () => {
  window.Quests?.open?.(); // ZAWSZE nowy Mission Board z opisami
});
        document.getElementById('qClose')?.addEventListener('click', () => { document.getElementById('qBack').style.display='none'; });

        dbg('Ready');
      } catch (fatal) {
        dbg('FATAL: '+(fatal && fatal.message ? fatal.message : 'error'));
        console.error('FATAL', fatal);
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', start, { once: true });
    } else {
      start();
    }
  </script>

  <!-- Mission Board scripts ‚Äî at very end -->
  <script src="js/quests.js?v=20251119b" defer></script>
  <script src="js/quests-launcher.js?v=20251010" defer></script>
  <script>
    // Fallback init (gdyby quests.js za≈Çadowa≈Ç siƒô po start())
    (function () {
      const tg = window.Telegram && window.Telegram.WebApp;
      const apiPost = (window.S && window.S.apiPost) || (async (path, data) => {
        const init_data = tg && tg.initData;
        const url = (window.API_BASE || "") + path;
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(init_data ? { Authorization: `Bearer ${init_data}` } : {})
          },
          body: JSON.stringify({ init_data, ...(data || {}) })
        });
        return res.json();
      });

      if (window.Quests && !window.__questsInited) {
        window.Quests.init({ apiPost, tg, dbg: console.debug });
        window.__questsInited = true;
      }
    })();
  </script>

  <!-- FAQ module + init -->
  <script src="js/faq.js?v=20251108" defer></script>
  <script>
    (function () {
      const tg = window.Telegram && window.Telegram.WebApp;
      const apiPost = (window.S && window.S.apiPost) || (async (path, data) => {
        const init_data = tg && tg.initData;
        const url = (window.API_BASE || "") + path;
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(init_data ? { Authorization: `Bearer ${init_data}` } : {})
          },
          body: JSON.stringify({ init_data, ...(data || {}) })
        });
        return res.json();
      });

      function tryInitFAQ(){
        if (window.FAQ && !window.__faqInited) {
          window.FAQ.init({ apiPost, tg, dbg: console.debug });
          window.__faqInited = true;
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', tryInitFAQ, { once:true });
      } else {
        tryInitFAQ();
      }
    })();
  </script>
</body>
</html>







