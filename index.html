<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Alpha Husky Dashboard</title>
  <meta name="color-scheme" content="dark light" />

  <!-- Preloady dla szybszego startu -->
  <link rel="preload" as="image" href="background_poster.jpg">
  <link rel="preload" as="video"  href="background3.webm" type="video/webm">
  <link rel="preload" as="video"  href="background3.mp4"  type="video/mp4">

  <style>
    :root {
      --glass: rgba(0,0,0,.45);
      --stroke: rgba(255,255,255,.18);
      --txt: #fff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background:#000; overscroll-behavior:none; }
    .app { position: fixed; inset: 0; overflow: hidden; height: calc(var(--vh, 1vh) * 100); }

    /* Background */
    .bg { position: absolute; inset: 0; z-index: 0; }
    .bg video, .bg .poster {
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
    }
    .bg video { filter: contrast(1.08) brightness(.9); }
    .bg .poster { display:none; background-position:center; background-size:cover; }

    /* UI layer */
    .ui { position: absolute; inset: 0; z-index: 2; }
    .grid { position:absolute; inset:0; display:grid; place-items:end center; padding: 24px; }

    /* Buttons */
    .row { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
    .btn {
      appearance:none; border:none; padding:12px 16px; border-radius:16px; color:var(--txt);
      background:var(--glass); border:1px solid var(--stroke); font:600 16px system-ui, sans-serif; cursor:pointer;
    }
    .btn:active { transform: translateY(1px); }

    /* Top bar */
    .topbar {
      position:absolute; top:12px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center;
      padding: calc(8px + env(safe-area-inset-top)) 12px 8px; border-radius:14px;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.25)); border:1px solid var(--stroke);
      color:#cfe7ff; font:500 14px system-ui, sans-serif;
    }
    .badge { padding:4px 8px; border-radius:999px; border:1px solid var(--stroke); background:rgba(0,0,0,.35); color:#aef; font-weight:700; }

    /* Safe area bottom */
    .spacer { height: max(12px, env(safe-area-inset-bottom)); }

    /* Reduced motion: wyłącz wideo, pokaż poster */
    @media (prefers-reduced-motion: reduce) {
      .bg video { display:none; }
      .bg .poster { display:block; }
    }

    /* Fallback overlay gdy otwarte poza Telegramem */
    .fallback {
      position: absolute; inset: 0; display:none; z-index: 3;
      background: rgba(0,0,0,.8); color:#fff; font: 500 16px system-ui, sans-serif;
      align-items:center; justify-content:center; text-align:center; padding:24px;
    }
    .fallback a { color:#aef; text-decoration:underline; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Background (zamień pliki na swoje) -->
    <div class="bg">
      <video autoplay muted loop playsinline poster="background_poster.jpg" preload="metadata">
        <source src="background3.webm" type="video/webm" />
        <source src="background3.mp4"  type="video/mp4" />
      </video>
      <div class="poster" style="background-image:url('background_poster.jpg');"></div>
    </div>

    <div id="app" class="ui">
      <div class="topbar">
        <div id="player">Alpha Husky</div>
        <div class="badge" id="faction">PACK</div>
      </div>

      <div class="grid">
        <div class="row">
          <button class="btn avatar"    aria-label="Open Avatar">Avatar</button>
          <button class="btn mission"   aria-label="Open Missions">Mission</button>
          <button class="btn inventory" aria-label="Open Inventory">Inventory</button>
          <button class="btn char"      aria-label="Open Character">Character</button>
          <button class="btn shop"      aria-label="Open Shop">Shop</button>
          <button class="btn pets"      aria-label="Open Pets">Pets</button>
        </div>
        <div class="spacer"></div>
      </div>
    </div>

    <div class="fallback" id="fallback">
      <div>
        <p>Open this page inside Telegram WebApp for full functionality.</p>
        <p>Go to <strong>Alpha Husky</strong> bot and tap <em>Open</em>.</p>
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // 100vh fix (stabilne wymiary na mobilkach)
      const setVh = () => document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
      setVh(); window.addEventListener('resize', setVh);

      const tg = window.Telegram?.WebApp;
      const $ = sel => document.querySelector(sel);

      if (!tg) {
        // Fallback poza Telegramem
        $("#fallback").style.display = "flex";
        return;
      }

      tg.ready();
      tg.expand();

      // Back (zamknij WebApp)
      tg.BackButton.show();
      tg.BackButton.onClick(() => tg.close());

      // Motyw TG → CSS variables
      const p = tg.themeParams || {};
      setVar('--glass',  p.secondary_bg_color ? hexToRgba(p.secondary_bg_color, 0.45) : 'rgba(0,0,0,.45)');
      setVar('--stroke', p.hint_color ? hexToRgba(p.hint_color, 0.22) : 'rgba(255,255,255,.18)');
      if (p.text_color) setVar('--txt', p.text_color);

      // Live theme update
      tg.onEvent('themeChanged', () => {
        const p2 = tg.themeParams || {};
        setVar('--glass',  p2.secondary_bg_color ? hexToRgba(p2.secondary_bg_color, 0.45) : 'rgba(0,0,0,.45)');
        setVar('--stroke', p2.hint_color ? hexToRgba(p2.hint_color, 0.22) : 'rgba(255,255,255,.18)');
        if (p2.text_color) setVar('--txt', p2.text_color);
      });

      // Ustawienie nazwy gracza
      const u = tg.initDataUnsafe?.user;
      if (u) $("#player").textContent = (u.username ? '@'+u.username : (u.first_name||'Player'));

      // Handshake: log w bocie, że WebApp się otworzył
      sendAction("webapp_opened", { version: "v0.1", ts: Date.now() });

      // MainButton (opcjonalny skrót)
      tg.MainButton.setText("Open Missions");
      tg.MainButton.onClick(() => sendAction("mission_open", { level: 1 }));
      tg.MainButton.show();

      // Mapowanie klików → JSON payload
      const actions = {
        ".btn.avatar":    () => sendAction("avatar_open"),
        ".btn.mission":   () => sendAction("mission_open", { level: 1 }),
        ".btn.inventory": () => sendAction("inventory_open"),
        ".btn.char":      () => sendAction("char_open"),
        ".btn.shop":      () => sendAction("shop_open"),
        ".btn.pets":      () => sendAction("pets_open"),
      };
      Object.entries(actions).forEach(([sel, fn]) => { const el = $(sel); if (el) el.onclick = fn; });

      // Helpers
      let _busy = false;
      function sendAction(action, extra = {}) {
        if (_busy) return;
        _busy = true; setTimeout(() => (_busy = false), 300); // anti double-tap

        try { tg.HapticFeedback?.impactOccurred("light"); } catch(e) {}
        const payload = {
          action,
          payload: { userId: tg?.initDataUnsafe?.user?.id, ...extra }
        };
        try {
          tg.sendData(JSON.stringify(payload));
        } catch (err) {
          tg.showAlert?.("Send failed. Try again.");
        }
      }

      function setVar(name, value){ document.documentElement.style.setProperty(name, value); }

      function hexToRgba(hex, a){
        if(!hex) return `rgba(0,0,0,${a})`;
        const h = hex.replace('#','');
        const full = h.length===3 ? h.split('').map(c=>c+c).join('') : h.slice(0,6);
        const n = parseInt(full,16);
        const r = (n>>16)&255, g=(n>>8)&255, b=n&255;
        return `rgba(${r},${g},${b},${a})`;
      }
    });
  </script>
</body>
</html>
